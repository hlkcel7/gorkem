/* ================================================
   BASÄ°T ARAMA (TEXT SEARCH) KOD BLOÄU
   ================================================ */

// 1. SUPABASE SERVÄ°SÄ°NDE BASÄ°T ARAMA FONKSÄ°YONU
// Dosya: /workspaces/gorkem/client/src/services/supabase.ts

async searchDocuments(
  query: string, 
  filters?: SearchFilters
): Promise<DocumentRecord[]> {
  try {
    if (!this.client) {
      throw new Error('Supabase istemcisi baÅŸlatÄ±lmamÄ±ÅŸ');
    }

    let queryBuilder = this.client
      .from('documents')
      .select('*');

    // Full-text search - basit arama (vector search zaten translation yapacak)
    if (query.trim()) {
      console.log(`ğŸ” Text search sorgusu: "${query}"`);
      
      queryBuilder = queryBuilder.or(
        `content.ilike.%${query}%,` +
        `short_desc.ilike.%${query}%,` +
        `keywords.ilike.%${query}%,` +
        `letter_no.ilike.%${query}%,` +
        `internal_no.ilike.%${query}%,` +
        `ref_letters.ilike.%${query}%`
      );
    }

    // Filtreler uygulama
    if (filters?.dateFrom) {
      queryBuilder = queryBuilder.gte('letter_date', filters.dateFrom);
    }

    if (filters?.dateTo) {
      queryBuilder = queryBuilder.lte('letter_date', filters.dateTo);
    }

    if (filters?.type_of_corr) {
      queryBuilder = queryBuilder.eq('type_of_corr', filters.type_of_corr);
    }

    if (filters?.severity_rate) {
      queryBuilder = queryBuilder.eq('severity_rate', filters.severity_rate);
    }

    if (filters?.inc_out) {
      queryBuilder = queryBuilder.eq('inc-out', filters.inc_out);
    }

    if (filters?.internal_no) {
      queryBuilder = queryBuilder.ilike('internal_no', `%${filters.internal_no}%`);
    }

    if (filters?.keywords && filters.keywords.length > 0) {
      const keywordSearch = filters.keywords.map(keyword => 
        `keywords.ilike.%${keyword}%`
      ).join(',');
      queryBuilder = queryBuilder.or(keywordSearch);
    }

    // SonuÃ§larÄ± sÄ±rala
    const sortBy = filters?.sortBy || 'letter_date';
    const sortOrder = filters?.sortOrder || 'desc';
    
    const { data, error } = await queryBuilder
      .order(sortBy, { ascending: sortOrder === 'asc' })
      .limit(DEFAULTS.TEXT_SEARCH_LIMIT); // Updated to use configurable limit

    if (error) {
      throw error;
    }

    console.log(`ğŸ“Š Text search: ${data?.length || 0} sonuÃ§ bulundu`);
    return data || [];

  } catch (error) {
    console.error('Supabase arama hatasÄ±:', error);
    throw new Error('VeritabanÄ± aramasÄ± baÅŸarÄ±sÄ±z oldu');
  }
}

// ================================================

// 2. HOOK'TA BASÄ°T ARAMA KULLANIMI
// Dosya: /workspaces/gorkem/client/src/hooks/useDocumentSearch.ts

// AI PASIF durumunda basit text search kullanÄ±mÄ±:
if (!enableAI) {
  // AI PASIF: Sadece basit text search kullan
  console.log('ğŸ“ Basit text search (AI pasif) yapÄ±lÄ±yor...');
  try {
    const textResults = await supabaseService.searchDocuments(query, filters);
    finalResults = textResults.map(doc => ({
      ...doc,
      similarity: 0.5,
      searchType: 'text' as const
    }));
    searchMethod = 'text';
    console.log(`âœ… Basit text search tamamlandÄ±: ${finalResults.length} sonuÃ§`);
  } catch (textError) {
    console.error('âŒ Basit text search baÅŸarÄ±sÄ±z:', textError);
    throw textError;
  }
}

// ================================================

// 3. ARAMA ALANLARI ve FÄ°LTRELEME
// Basit aramada taranacak alanlar:

const searchFields = [
  'content',      // Belge iÃ§eriÄŸi (ana metin)
  'short_desc',   // KÄ±sa aÃ§Ä±klama
  'keywords',     // Anahtar kelimeler
  'letter_no',    // Mektup numarasÄ±
  'internal_no',  // Dahili numara
  'ref_letters'   // Referans mektuplar
];

// Ek filtreleme alanlarÄ±:
const filterFields = {
  'letter_date': 'Mektup tarihi (tarih aralÄ±ÄŸÄ±)',
  'type_of_corr': 'YazÄ±ÅŸma tÃ¼rÃ¼',
  'severity_rate': 'Ã–nem derecesi',
  'inc-out': 'Gelen/Giden',
  'internal_no': 'Dahili numara (kÄ±smi eÅŸleÅŸme)',
  'keywords': 'Anahtar kelimeler (dizi)'
};

// ================================================

// 4. SINIRLAMA ve SIRALAMA
const DEFAULTS = {
  TEXT_SEARCH_LIMIT: 20000,     // Maksimum sonuÃ§ sayÄ±sÄ±
  VECTOR_THRESHOLD: 0.3,      // Vector benzerlik eÅŸiÄŸi
  VECTOR_FALLBACK_COUNT: 10   // Fallback sonuÃ§ sayÄ±sÄ±
};

// SÄ±ralama seÃ§enekleri:
const sortOptions = {
  'letter_date': 'Mektup tarihine gÃ¶re',
  'similarity': 'Benzerlik skoruna gÃ¶re',
  'severity_rate': 'Ã–nem derecesine gÃ¶re',
  'short_desc': 'AÃ§Ä±klamaya gÃ¶re',
  'letter_no': 'Mektup numarasÄ±na gÃ¶re'
};

// ================================================

// 5. KULLANICILAR Ä°Ã‡Ä°N BASÄ°T ARAMA AKIÅI

/*
1. KullanÄ±cÄ± arama kutusuna metin girer
2. AI ayarÄ± pasifse (enableAI = false) basit arama tetiklenir
3. PostgreSQL ILIKE operatÃ¶rÃ¼ ile 6 alanda arama yapÄ±lÄ±r:
   - content (iÃ§erik)
   - short_desc (kÄ±sa aÃ§Ä±klama)  
   - keywords (anahtar kelimeler)
   - letter_no (mektup no)
   - internal_no (dahili no)
   - ref_letters (referans mektuplar)
4. Ek filtreler uygulanÄ±r (tarih, tÃ¼r, Ã¶nem, vs.)
5. SonuÃ§lar tarihe gÃ¶re azalan sÄ±rada dÃ¶ndÃ¼rÃ¼lÃ¼r
6. Maksimum 20000 sonuÃ§ gÃ¶sterilir
*/

// ================================================

// 6. PERFORMANS ve GÃœVEN

/*
AVANTAJLAR:
- HÄ±zlÄ± ve gÃ¼venilir
- AI API'lerine baÄŸÄ±mlÄ± deÄŸil
- TÃ¼rkÃ§e karakterleri destekler
- KÄ±smi kelime eÅŸleÅŸtirmesi (ILIKE %text%)
- Ã‡oklu alan aramasÄ±
- Esnek filtreleme

KISITLAR:
- Anlam tabanlÄ± arama yok
- Sinonim desteÄŸi sÄ±nÄ±rlÄ±
- Benzerlik skoru basit (0.5 sabit)
- Kelime sÄ±rasÄ± Ã¶nemli deÄŸil
*/
